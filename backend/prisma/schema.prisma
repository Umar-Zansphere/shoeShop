generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  CUSTOMER
}

enum Purpose {
  LOGIN
  SIGNUP
  RESET_PASSWORD
  VERIFICATION
}

enum Category {
  RUNNING
  CASUAL
  FORMAL
  SNEAKERS
}

enum Gender {
  MEN
  WOMEN
  UNISEX
  KIDS
}

enum CartStatus {
  ACTIVE
  ORDERED
  ABANDONED
}

enum OrderStatus {
  PENDING
  PAID
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

enum PaymentGateway {
  RAZORPAY
  COD
}

enum OrderShipmentStatus {
  PENDING
  SHIPPED
  DELIVERED
  RETURNED
  LOST
}

enum InventoryLogType {
  HOLD
  RELEASE
  SOLD
  MANUAL
  RESTOCK
  RETURN
}

model User {
  id                     String    @id @default(uuid())
  email                  String?   @unique @db.VarChar(255)
  password               String?   @db.VarChar(255)
  phone                  String?   @unique @db.VarChar(20)
  fullName               String?   @map("full_name") @db.VarChar(255)
  emailVerificationToken String?   @unique @map("email_verification_token")
  is_email_verified      DateTime? @map("is_email_verified")
  is_phone_verified      DateTime? @map("is_phone_verified")
  is_active              Boolean   @default(false)
  isGuest                Boolean   @default(true)
  last_login_at          DateTime? @map("last_login_at") @db.Timestamptz(6)
  passwordResetToken     String?   @unique @map("password_reset_token")
  passwordResetExpires   DateTime? @map("password_reset_expires")
  role                   Role      @default(CUSTOMER)
  createdAt              DateTime  @default(now())
  updatedAt              DateTime? @updatedAt

  otpVerifications        OtpVerification[]
  sessions                UserSession[]
  addresses               Address[]
  carts                   Cart[]
  wishlists               Wishlist[]
  orders                  Order[]
  orderLogs               OrderLog[]               @relation("OrderLogActor")
  shipmentLogs            ShipmentLog[]            @relation("ShipmentLogActor")
  paymentLogs             PaymentLog[]             @relation("PaymentLogActor")
  pushSubscriptions       PushSubscription[]
  notificationHistory     NotificationHistory[]
  notificationPreferences NotificationPreferences?
}

model GuestSession {
  id        String   @id @default(uuid())
  sessionId String   @unique @map("session_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  carts             Cart[]
  wishlists         Wishlist[]
  otpVerifications  OtpVerification[]
  orders            Order[]
  pushSubscriptions PushSubscription[]

  @@index([sessionId])
  @@index([expiresAt])
}

model OtpVerification {
  id         String        @id @default(uuid())
  userId     String?       @map("user_id")
  user       User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionId  String?       @map("session_id")
  session    GuestSession? @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  phone      String?       @db.VarChar(20)
  identifier String        @default("phone") // email or phone
  otpHash    String        @map("otp_hash")
  purpose    Purpose
  expiresAt  DateTime      @map("expires_at")
  verifiedAt DateTime?     @map("verified_at")
  createdAt  DateTime      @default(now()) @map("created_at")

  @@index([sessionId])
}

model UserSession {
  id               String   @id @default(uuid())
  userId           String   @map("user_id")
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  refreshTokenHash String   @map("refresh_token_hash")
  deviceInfo       String   @map("device_info")
  ipAddress        String   @map("ip_address")
  expiresAt        DateTime @map("expires_at")
  createdAt        DateTime @default(now()) @map("created_at")
}

model Address {
  id           String   @id @default(uuid())
  userId       String?  @map("user_id")
  user         User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  name         String // Home, Office
  phone        String   @db.VarChar(20)
  addressLine1 String   @map("address_line_1")
  addressLine2 String?  @map("address_line_2")
  city         String
  state        String
  postalCode   String   @map("postal_code")
  country      String
  isDefault    Boolean  @default(false) @map("is_default")
  createdAt    DateTime @default(now()) @map("created_at")
}

model Product {
  id               String   @id @default(uuid())
  name             String   @db.VarChar(255)
  brand            String   @db.VarChar(255)
  modelNumber      String?  @map("model_number") @db.VarChar(255)
  category         Category
  gender           Gender
  description      String?  @db.Text
  shortDescription String?  @map("short_description")
  tags             String[]
  isActive         Boolean  @default(true) @map("is_active")
  isFeatured       Boolean  @default(false) @map("is_featured")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  variants      ProductVariant[]
  cartItems     CartItem[]
  wishlistItems WishlistItem[]
}

model ProductImage {
  id        String         @id @default(uuid())
  variantId String
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  url       String
  altText   String         @map("alt_text")
  position  Int
  isPrimary Boolean        @default(false) @map("is_primary")
  createdAt DateTime       @default(now()) @map("created_at")

  @@index([variantId])
}

model ProductVariant {
  id             String   @id @default(uuid())
  productId      String   @map("product_id")
  product        Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  size           String   @db.VarChar(10)
  color          String   @db.VarChar(50)
  sku            String   @unique
  price          Decimal  @db.Decimal(10, 2)
  compareAtPrice Decimal? @map("compare_at_price") @db.Decimal(10, 2)
  isAvailable    Boolean  @default(true) @map("is_available")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  images        ProductImage[]
  inventoryLogs InventoryLog[]
  cartItems     CartItem[]
  wishlistItems WishlistItem[]
  orderItems    OrderItem[]    @relation("OrderItems")
  inventory     Inventory?

  @@unique([productId, size, color])
}

model Inventory {
  id        String         @id @default(uuid())
  variantId String         @unique
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  quantity  Int
  reserved  Int            @default(0) // for HOLD
  updatedAt DateTime       @updatedAt

  @@index([updatedAt])
}

model InventoryLog {
  id          String           @id @default(uuid())
  variantId   String           @map("variant_id")
  variant     ProductVariant   @relation(fields: [variantId], references: [id], onDelete: Cascade)
  orderId     String?          @map("order_id")
  order       Order?           @relation(fields: [orderId], references: [id], onDelete: SetNull)
  quantity    Int
  type        InventoryLogType
  createdAt   DateTime         @default(now()) @map("created_at")
  performedBy String? // admin or system
  note        String?
}

model Cart {
  id        String        @id @default(uuid())
  userId    String?       @map("user_id")
  user      User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionId String?       @map("session_id")
  session   GuestSession? @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  status    CartStatus    @default(ACTIVE)
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")

  items CartItem[]

  @@unique([userId, status])
  @@unique([sessionId, status])
  @@index([userId])
  @@index([sessionId])
}

model CartItem {
  id        String         @id @default(uuid())
  cartId    String         @map("cart_id")
  cart      Cart           @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId String         @map("product_id")
  product   Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantId String         @map("variant_id")
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  quantity  Int
  unitPrice Decimal        @db.Decimal(10, 2)
  createdAt DateTime       @default(now()) @map("created_at")
  updatedAt DateTime       @updatedAt @map("updated_at")

  @@index([cartId])
  @@index([productId])
  @@index([variantId])
}

model Wishlist {
  id        String        @id @default(uuid())
  userId    String?       @map("user_id")
  user      User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionId String?       @map("session_id")
  session   GuestSession? @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  createdAt DateTime      @default(now()) @map("created_at")

  items WishlistItem[]

  @@unique([userId])
  @@unique([sessionId])
  @@index([userId])
  @@index([sessionId])
}

model WishlistItem {
  id         String          @id @default(uuid())
  wishlistId String          @map("wishlist_id")
  wishlist   Wishlist        @relation(fields: [wishlistId], references: [id], onDelete: Cascade)
  productId  String          @map("product_id")
  product    Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantId  String?         @map("variant_id")
  variant    ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  @@unique([wishlistId, productId, variantId])
}

model Order {
  id                String         @id @default(uuid())
  userId            String?        @map("user_id")
  user              User?          @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionId         String?        @map("session_id")
  session           GuestSession?  @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  orderNumber       String         @unique @map("order_number")
  trackingToken     String?        @unique @map("tracking_token")
  status            OrderStatus    @default(PENDING)
  paymentStatus     PaymentStatus  @default(PENDING) @map("payment_status")
  paymentMethod     PaymentGateway @map("payment_method")
  razorpayOrderId   String?        @unique @map("razorpay_order_id")
  razorpayPaymentId String?        @unique @map("razorpay_payment_id")
  totalAmount       Decimal        @map("total_amount") @db.Decimal(12, 2)
  deletedAt         DateTime?      @map("deleted_at")
  deleteReason      String?        @map("delete_reason")
  deletedBy         String?        @map("deleted_by")
  createdAt         DateTime       @default(now()) @map("created_at")

  items         OrderItem[]
  payments      Payment[]
  shipments     OrderShipment[]
  orderLogs     OrderLog[]
  shipmentLogs  ShipmentLog[]
  paymentLogs   PaymentLog[]
  inventoryLogs InventoryLog[]
  orderAddress  OrderAddress?

  @@index([orderNumber])
  @@index([trackingToken])
  @@index([deletedAt])
}

model OrderItem {
  id          String         @id @default(uuid())
  orderId     String         @map("order_id")
  order       Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variantId   String         @map("variant_id")
  variant     ProductVariant @relation("OrderItems", fields: [variantId], references: [id], onDelete: Restrict)
  productName String         @map("product_name")
  color       String
  size        String
  price       Decimal        @db.Decimal(10, 2)
  quantity    Int
  subtotal    Decimal        @db.Decimal(12, 2)
  createdAt   DateTime       @default(now()) @map("created_at")

  @@index([orderId])
  @@index([variantId])
}

model OrderAddress {
  id           String  @id @default(uuid())
  orderId      String  @unique
  order        Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  name         String
  phone        String?
  email        String?
  addressLine1 String
  addressLine2 String?
  city         String
  state        String
  postalCode   String
  country      String
}

model Payment {
  id                String         @id @default(uuid())
  orderId           String         @map("order_id")
  order             Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  gateway           PaymentGateway
  gatewayOrderId    String?        @map("gateway_order_id")
  gatewayPaymentId  String?        @map("gateway_payment_id")
  externalReference String?        @map("external_reference")
  idempotencyKey    String?        @map("idempotency_key")
  amount            Decimal        @db.Decimal(12, 2)
  status            PaymentStatus
  paidAt            DateTime?      @map("paid_at")
  note              String?
  metadata          Json?
  deletedAt         DateTime?      @map("deleted_at")
  deleteReason      String?        @map("delete_reason")
  deletedBy         String?        @map("deleted_by")
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")

  paymentLogs PaymentLog[]

  @@unique([gateway, gatewayPaymentId])
  @@unique([gateway, gatewayOrderId])
  @@index([orderId])
  @@index([orderId, idempotencyKey])
  @@index([status])
  @@index([deletedAt])
  @@index([createdAt])
}

model PaymentLog {
  id                  String         @id @default(uuid())
  paymentId           String?        @map("payment_id")
  payment             Payment?       @relation(fields: [paymentId], references: [id], onDelete: SetNull)
  orderId             String?        @map("order_id")
  order               Order?         @relation(fields: [orderId], references: [id], onDelete: SetNull)
  orderNumberSnapshot String?        @map("order_number_snapshot")
  adminId             String?        @map("admin_id")
  admin               User?          @relation("PaymentLogActor", fields: [adminId], references: [id], onDelete: SetNull)
  action              String         @db.VarChar(50)
  fromStatus          PaymentStatus? @map("from_status")
  toStatus            PaymentStatus? @map("to_status")
  amount              Decimal?       @db.Decimal(12, 2)
  note                String?
  metadata            Json?
  createdAt           DateTime       @default(now()) @map("created_at")

  @@index([paymentId])
  @@index([orderId])
  @@index([adminId])
  @@index([action])
  @@index([createdAt])
}

model OrderShipment {
  id             String              @id @default(uuid())
  orderId        String              @map("order_id")
  order          Order               @relation(fields: [orderId], references: [id], onDelete: Cascade)
  courierName    String?             @map("courier_name")
  trackingNumber String?             @map("tracking_number")
  trackingUrl    String?             @map("tracking_url")
  status         OrderShipmentStatus @default(PENDING)
  shippedAt      DateTime?           @map("shipped_at")
  deletedAt      DateTime?           @map("deleted_at")
  deleteReason   String?             @map("delete_reason")
  deletedBy      String?             @map("deleted_by")
  createdAt      DateTime            @default(now()) @map("created_at")

  shipmentLogs ShipmentLog[]

  @@index([deletedAt])
}

model OrderLog {
  id                  String         @id @default(uuid())
  orderId             String?        @map("order_id")
  order               Order?         @relation(fields: [orderId], references: [id], onDelete: SetNull)
  orderNumberSnapshot String?        @map("order_number_snapshot")
  adminId             String?        @map("admin_id")
  admin               User?          @relation("OrderLogActor", fields: [adminId], references: [id], onDelete: SetNull)
  action              String         @db.VarChar(50)
  fromStatus          OrderStatus?   @map("from_status")
  toStatus            OrderStatus?   @map("to_status")
  fromPaymentStatus   PaymentStatus? @map("from_payment_status")
  toPaymentStatus     PaymentStatus? @map("to_payment_status")
  note                String?
  metadata            Json?
  createdAt           DateTime       @default(now()) @map("created_at")

  @@index([orderId])
  @@index([adminId])
  @@index([action])
  @@index([createdAt])
}

model ShipmentLog {
  id                  String               @id @default(uuid())
  orderId             String?              @map("order_id")
  order               Order?               @relation(fields: [orderId], references: [id], onDelete: SetNull)
  orderNumberSnapshot String?              @map("order_number_snapshot")
  shipmentId          String?              @map("shipment_id")
  shipment            OrderShipment?       @relation(fields: [shipmentId], references: [id], onDelete: SetNull)
  adminId             String?              @map("admin_id")
  admin               User?                @relation("ShipmentLogActor", fields: [adminId], references: [id], onDelete: SetNull)
  action              String               @db.VarChar(50)
  fromStatus          OrderShipmentStatus? @map("from_status")
  toStatus            OrderShipmentStatus? @map("to_status")
  courierName         String?              @map("courier_name")
  trackingNumber      String?              @map("tracking_number")
  trackingUrl         String?              @map("tracking_url")
  note                String?
  metadata            Json?
  createdAt           DateTime             @default(now()) @map("created_at")

  @@index([orderId])
  @@index([shipmentId])
  @@index([adminId])
  @@index([action])
  @@index([createdAt])
}

model PushSubscription {
  id        String        @id @default(uuid())
  userId    String?       @map("user_id")
  user      User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionId String?       @map("session_id")
  session   GuestSession? @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  endpoint  String        @unique
  p256dh    String // Encryption key
  auth      String // Authentication secret
  userAgent String?       @map("user_agent")
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")

  @@index([userId])
  @@index([sessionId])
  @@index([endpoint])
}

model NotificationHistory {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  body      String
  url       String?
  icon      String?
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

model NotificationPreferences {
  id                String   @id @default(uuid())
  userId            String   @unique @map("user_id")
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  newOrders         Boolean  @default(true) @map("new_orders")
  orderStatusChange Boolean  @default(true) @map("order_status_change")
  lowStock          Boolean  @default(true) @map("low_stock")
  otherEvents       Boolean  @default(true) @map("other_events")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
}
